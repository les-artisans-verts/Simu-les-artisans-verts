<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calcul Aides PAC</title>
  <style>
    :root {
      --bg1:#dff7e5; --bg2:#a8e6b5; --bg3:#73d49a;
      --card:#ffffff; --text:#0c2a1a; --muted:#3e6b55; --accent:#16784e;
      --bleu:#2563eb; --jaune:#f59e0b; --violet:#7c3aed; --rose:#db2777;
      --green:#00b050; --red:#c00000;
    }
    * { box-sizing:border-box }
    body {
      margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; color:#0c2a1a;
      background:linear-gradient(180deg,var(--bg1),var(--bg2),var(--bg3)); min-height:100vh;
    }
    .wrap { max-width:980px; margin:24px auto 40px; padding:0 16px }
    .header { display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:12px }
    h1 { margin:0; font-size:26px; letter-spacing:.2px; color:#0a3d28; text-align:center }
    .card {
      background:var(--card); border:1px solid rgba(12,42,26,.08); border-radius:18px;
      box-shadow:0 10px 30px rgba(12,42,26,.10); padding:22px;
    }
    .grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:16px }
    @media (max-width:800px){ .grid { grid-template-columns:1fr } }
    .field { display:flex; flex-direction:column; gap:8px }
    label { font-weight:700; color:#0a3d28 }
    select, input[type=number], input[type=text] {
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(12,42,26,.25);
      background:#f6fff8; color:#0c2a1a; outline:none; transition:border .15s ease, box-shadow .15s ease
    }
    select:focus, input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(22,120,78,.2) }
    .line { height:1px; background:rgba(12,42,26,.15); margin:18px 0 }
    .badge { display:inline-block; padding:6px 12px; border-radius:999px; font-weight:800 }
    .badge.green { color:#fff; background:linear-gradient(90deg,#00b050,#049a47) }
    .badge.red   { color:#fff; background:linear-gradient(90deg,#c00000,#a40000) }

    .mpr { display:flex; gap:12px; flex-wrap:wrap }
    .mpr .chip {
      min-width:180px; display:flex; align-items:center; justify-content:center;
      padding:12px 16px; border-radius:12px; color:#fff; font-weight:900; cursor:pointer;
      box-shadow:0 6px 14px rgba(12,42,26,.15); border:2px solid transparent; user-select:none
    }
    .mpr .chip.active { outline:3px solid rgba(22,120,78,.25); border-color:#0fb36b }
    .chip.bleu   { background:var(--bleu) }
    .chip.jaune  { background:var(--jaune) }
    .chip.violet { background:var(--violet) }
    .chip.rose   { background:var(--rose) }

    @media (max-width: 640px){
      .mpr { 
        display:grid; 
        grid-template-columns: repeat(2, minmax(0, 1fr)); 
        gap:10px;
      }
      .mpr .chip{
        min-width:0;
        width:100%;
        padding:12px 10px;
        font-size:15px;
      }
    }

    .hint { font-size:12px; color:#3b5f4d }
    .result { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; margin-top:16px }
    .metric { background:#f8fff9; border:1px dashed rgba(12,42,26,.2); border-radius:12px; padding:14px }
    .metric h3 { margin:0 0 6px; font-size:14px; color:#3b5f4d }
    .metric .val { font-size:20px; font-weight:800; color:#0a3d28 }

    footer { text-align:center; margin-top:18px; color:#0a3d28; opacity:.9; font-weight:700 }
    footer .powered { display:inline-block; background:#ffffffc7; border:1px solid rgba(12,42,26,.15); padding:8px 12px; border-radius:999px }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Calcul Aides PAC</h1>
    </div>

    <div class="card">
      <div class="grid">
        <div class="field">
          <label for="typeLogement">Type de logement</label>
          <select id="typeLogement">
            <option value="maison">Maison individuelle</option>
            <option value="appartement">Appartement</option>
          </select>
        </div>
        <div class="field">
          <label for="etas">ETAS</label>
          <select id="etas">
            <option value="111-140">111 ≤ Etas < 140</option>
            <option value="140-170" selected>140 ≤ Etas < 170</option>
            <option value="170-200">170 ≤ Etas < 200</option>
            <option value="200+">Etas ≥ 200</option>
          </select>
        </div>

        <div class="field">
          <label for="usage">Usage</label>
          <select id="usage">
            <option selected>Chauffage</option>
            <option>Chauffage et ECS</option>
          </select>
        </div>

        <div class="field">
          <label for="surfaceM2">Surface chauffée (m²)</label>
          <input id="surfaceM2" type="number" min="0" step="1" placeholder="ex : 95" />
          <div class="hint" id="surfaceHint">Facteur surface : 1,0 — Classe 90–109</div>
        </div>

        <div class="field">
          <label for="zone">Zone géographique</label>
          <select id="zone">
            <option value="H1" selected>H1</option>
            <option value="H2">H2</option>
            <option value="H3">H3</option>
          </select>
        </div>
        <div class="field">
          <label for="mwhCumacPrice">Prix du MWh cumac</label>
          <input id="mwhCumacPrice" type="number" step="0.1" min="0" value="12.5" />
        </div>

        <div class="field" id="ecsField">
          <label for="ecs">Type d’ECS</label>
          <select id="ecs">
            <option value="">Choisir</option>
            <option>Ballon thermodynamique</option>
            <option>Ballon électrique</option>
            <option>Ballon SSC</option>
          </select>
        </div>
        <div class="field">
          <label>Catégorie MPR</label>
          <div id="mprChips" class="mpr">
            <div class="chip bleu active" data-cat="bleu">Très modestes</div>
            <div class="chip jaune" data-cat="jaune">Modestes</div>
            <div class="chip violet" data-cat="violet">Intermédiaires</div>
            <div class="chip rose" data-cat="rose">Supérieurs</div>
          </div>
        </div>

        <div class="field">
          <label>Délégataire</label>
          <div id="delegBadge" class="badge">—</div>
        </div>
      </div>

      <div class="line"></div>

      <div class="result">
        <div class="metric">
          <h3>kWh cumac total</h3>
          <div class="val"><span id="kwhCumacTotal">0</span> kWh</div>
        </div>
        <div class="metric">
          <h3>Prime CEE estimée</h3>
          <div class="val"><span id="estimatedPrimeCEE">0,00</span> €</div>
        </div>
        <div class="metric">
          <h3>Aide MaPrimeRénov’</h3>
          <div class="val"><span id="mpRenovAide">0,00</span> €</div>
        </div>
        <div class="metric">
          <h3>Total des aides</h3>
          <div class="val"><span id="totalAides">0,00</span> €</div>
        </div>
      </div>
    </div>

    <footer><div class="powered">Powered by Gamberge</div></footer>
  </div>

  <script>
    // tables de base
    const base = {
      maison: {
        baseValues: {
          '111-140': { 'Chauffage et ECS': 96700, 'Chauffage': 79500 },
          '140-170': { 'Chauffage et ECS': 111500, 'Chauffage': 91600 },
          '170-200': { 'Chauffage et ECS': 121400, 'Chauffage': 99700 },
          '200+':    { 'Chauffage et ECS': 125800, 'Chauffage': 103400 }
        },
        ranges: [
          {min:0,   max:70,   factor:0.5, label:'S < 70', ge130:false},
          {min:70,  max:90,   factor:0.7, label:'70 ≤ S < 90', ge130:false},
          {min:90,  max:110,  factor:1.0, label:'90 ≤ S < 110', ge130:false},
          {min:110, max:130,  factor:1.1, label:'110 ≤ S < 130', ge130:false},
          {min:130, max:Infinity, factor:1.6, label:'S ≥ 130', ge130:true},
        ]
      },
      appartement: {
        baseValues: {
          '111-140': { 'Chauffage et ECS': 54000, 'Chauffage': 38400 },
          '140-170': { 'Chauffage et ECS': 62300, 'Chauffage': 44300 },
          '170-200': { 'Chauffage et ECS': 67800, 'Chauffage': 48200 },
          '200+':    { 'Chauffage et ECS': 70300, 'Chauffage': 50000 }
        },
        ranges: [
          {min:0,   max:35,   factor:0.5, label:'S < 35', ge130:false},
          {min:35,  max:60,   factor:0.7, label:'35 ≤ S < 60', ge130:false},
          {min:60,  max:70,   factor:1.0, label:'60 ≤ S < 70', ge130:false},
          {min:70,  max:90,   factor:1.2, label:'70 ≤ S < 90', ge130:false},
          {min:90,  max:110,  factor:1.5, label:'90 ≤ S < 110', ge130:false},
          {min:110, max:130.0001, factor:1.9, label:'110 ≤ S ≤ 130', ge130:true},
          {min:130.0001, max:Infinity, factor:2.5, label:'S > 130', ge130:true},
        ]
      },
      zoneFactors: {H1:1.2, H2:1, H3:0.7}
    };

    const mprPAC = { bleu: 5000, jaune: 4000, violet: 3000, rose: 0 };
    const mprByEcs = {
      "Ballon thermodynamique": { bleu: 1200, jaune: 800, violet: 400, rose: 0 },
      "Ballon électrique": { bleu: 0, jaune: 0, violet: 0, rose: 0 },
      "Ballon SSC": { bleu: 10000, jaune: 8000, violet: 4000, rose: 0 }
    };

    let currentMprCat = 'bleu';

    const euro = n => Number(n).toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2});

    function pickRange(type, s) {
      const arr = base[type].ranges;
      for (const r of arr) {
        if (s >= r.min && s < r.max) return r;
      }
      return arr.find(r=>r.factor===1) || arr[0];
    }

    function updateSurfaceHint() {
      const type = document.getElementById('typeLogement').value;
      const s = parseFloat(document.getElementById('surfaceM2').value);
      const hint = document.getElementById('surfaceHint');
      if (isNaN(s)) { hint.textContent = 'Facteur surface : 1,0 — Classe 90–109'; return; }
      const r = pickRange(type, s);
      hint.textContent = `Facteur surface : ${r.factor.toLocaleString('fr-FR')} — ${r.label}`;
    }

    function renderDelegAuto() {
      const type = document.getElementById('typeLogement').value;
      const s = parseFloat(document.getElementById('surfaceM2').value);
      const ecs = (document.getElementById('ecs').value || '').toLowerCase();
      const badge = document.getElementById('delegBadge');
      let ge130 = false;
      if (!isNaN(s)) ge130 = s >= 130;
      let name, cls;
      if (ge130 && !ecs.includes('ssc')) { name='ECO NEGOCE'; cls='green'; }
      else { name='VALOREN'; cls='red'; }
      badge.className = 'badge ' + cls;
      badge.textContent = name;
      updateCumacPrice();
    }

    function updateCumacPrice() {
      const deleg = document.getElementById('delegBadge').textContent.trim().toUpperCase();
      let price;
      if (deleg === 'VALOREN') {
        price = (currentMprCat === 'bleu') ? 11.0 : 7.0;
      } else {
        price = (currentMprCat === 'bleu') ? 12.5 : 7.4;
      }
      document.getElementById('mwhCumacPrice').value = price.toFixed(1);
    }

    function mprBallonAmount(ecstype, cat) {
      const table = mprByEcs[ecstype] || {bleu:0, jaune:0, violet:0, rose:0};
      return table[cat] || 0;
    }

    function calculate() {
      const typeLogement = document.getElementById('typeLogement').value;
      const etas = document.getElementById('etas').value;
      const usage = document.getElementById('usage').value;
      const s = parseFloat(document.getElementById('surfaceM2').value);
      const zone = document.getElementById('zone').value;
      const mwhCumacPrice = parseFloat(document.getElementById('mwhCumacPrice').value);
      const ecsType = document.getElementById('ecs').value;

      if (isNaN(mwhCumacPrice) || mwhCumacPrice < 0) {
        document.getElementById('kwhCumacTotal').textContent = "0";
        document.getElementById('estimatedPrimeCEE').textContent = "0,00";
        document.getElementById('mpRenovAide').textContent = "0,00";
        document.getElementById('totalAides').textContent = "0,00";
        return;
      }

      const baseKwhCumac = base[typeLogement].baseValues[etas][usage];
      const r = isNaN(s) ? pickRange(typeLogement, 95) : pickRange(typeLogement, s); // défaut classe 90–109
      const surfaceFactor = r.factor;
      const zoneFactor = base.zoneFactors[zone];

      let finalKwhCumac = baseKwhCumac * surfaceFactor * zoneFactor * 5;

      // CEE PAC
      let cee = (finalKwhCumac / 1000) * mwhCumacPrice;

      // + CEE Ballon Thermodynamique (forfait selon délégataire)
      const deleg = document.getElementById('delegBadge').textContent.trim().toUpperCase();
      if (ecsType === 'Ballon thermodynamique') {
        const ceeBallon = (deleg === 'VALOREN') ? 109.2 : (deleg === 'ECO NEGOCE' ? 101.4 : 0);
        cee += ceeBallon;
      }

      // MPR = PAC + Ballon (selon sélection)
      const mprPac = mprPAC[currentMprCat] || 0;
      const mprBallon = ecsType ? mprBallonAmount(ecsType, currentMprCat) : 0;
      const mprTotal = mprPac + mprBallon;

      const total = cee + mprTotal;

      document.getElementById('kwhCumacTotal').textContent = Math.round(finalKwhCumac).toLocaleString('fr-FR');
      document.getElementById('estimatedPrimeCEE').textContent = euro(cee);
      document.getElementById('mpRenovAide').textContent = euro(mprTotal);
      document.getElementById('totalAides').textContent = euro(total);
    }

    function initMprChips() {
      const cont = document.getElementById('mprChips');
      cont.querySelectorAll('.chip').forEach(el => {
        el.addEventListener('click', () => {
          cont.querySelectorAll('.chip').forEach(s => s.classList.remove('active'));
          el.classList.add('active');
          currentMprCat = el.getAttribute('data-cat');
          updateCumacPrice();
          calculate();
        });
      });
    }

    // events
    document.getElementById('typeLogement').addEventListener('change', () => { updateSurfaceHint(); renderDelegAuto(); calculate(); });
    document.getElementById('etas').addEventListener('change', calculate);
    document.getElementById('usage').addEventListener('change', calculate);
    document.getElementById('surfaceM2').addEventListener('input', () => { updateSurfaceHint(); renderDelegAuto(); calculate(); });
    document.getElementById('zone').addEventListener('change', calculate);
    document.getElementById('mwhCumacPrice').addEventListener('input', calculate);
    document.getElementById('ecs').addEventListener('change', () => { renderDelegAuto(); calculate(); });

    document.addEventListener('DOMContentLoaded', () => {
      initMprChips();
      updateSurfaceHint();
      renderDelegAuto();
      updateCumacPrice();
      calculate();
    });
  </script>
</body>
</html>
